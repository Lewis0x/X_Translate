# 文档翻译工具需求与方案

## 1. 背景与目标
当前大量技术文档以 .docx 形式沉淀，翻译时常因格式被破坏而产生二次排版成本。目标是开发一个翻译工具：在完整复制原文档的基础上，仅替换文本内容，最大限度保持原有格式、样式和排版一致性。

## 2. 范围与边界
### 2.1 范围
- 输入格式：.docx、.pdf（可选文本型）、.xlsx（可扩展 .pptx）
- 输出格式：与输入格式一致（同目录，带语言后缀）
- 语言方向：中 -> 英（可扩展）
- 翻译方式：调用 OpenAI API
- 术语表：强制生效

### 2.2 不在范围
- 不做格式重排、结构重建或样式调整
- 不做图片、图表内容的 OCR 翻译
- 不对扫描件 PDF 做翻译

## 3. 需求说明
### 3.1 功能需求
1. 复制原始文档并在副本上进行翻译，保留所有样式、页眉页脚、表格、目录与脚注。
2. 仅替换文档中的文字内容，不改动任何格式属性。
3. 支持批量处理多个 .docx / .pdf / .xlsx 文件。
4. 支持术语表（强制替换/不翻译）并可配置大小写敏感。
5. 支持输出语言后缀命名，例如：`需求说明_zh.docx` -> `需求说明_en.docx`。
6. 提供翻译日志与摘要报告，便于抽检。
7. 预留扩展接口，支持插件化集成（浏览器、Office、WPS）。

### 3.2 非功能需求
- 格式一致性：翻译后文档的样式与布局不应出现明显变化。
- 稳定性：批量处理 50+ 文档不崩溃。
- 可观测性：输出日志包含错误、告警与关键统计。
- 可维护性：模块化设计，便于扩展新语言与新引擎。

## 4. 使用流程
1. 准备原始文档与术语表（CSV/JSON）。
2. 执行命令：`doc_translator --input xxx.docx --target en --glossary glossary.csv`。
3. 生成翻译输出文件与报告。
4. 进行抽检与格式对比。

## 5. 技术方案
### 5.1 核心思路
- 以“复制 + 文本替换”为主线：读取 docx 内部 XML，定位 `w:t` 文本节点，替换其文本值。
- 保留 run/paragraph 结构，避免重建段落或重新排版。

### 5.2 组件设计
1. **CLI 层**
   - 参数解析、批量遍历、任务调度
2. **文档适配层**
   - Docx 解析：打开 docx（zip），定位 `word/document.xml` 以及页眉页脚、脚注、表格相关 xml
   - PDF 解析：提取文本型 PDF 的文本块并映射回页面位置
   - Xlsx 解析：遍历单元格与共享字符串表
3. **翻译器**
   - 调用 OpenAI API
   - 批次翻译、重试与限流
4. **术语表模块**
   - 预处理与后处理替换
   - 支持正则与固定词条
5. **报告模块**
   - 统计翻译字数、错误条目、命中术语
6. **扩展与集成层**
   - Chrome 插件：页面选区翻译与下载翻译结果
   - Office/WPS 插件：在应用内触发翻译并回写文档

### 5.3 关键细节
- **格式保持策略**：仅替换对应文本节点，避免合并/拆分段落。
- **批次处理**：按段落/句子分批，提高质量并避免 token 超限。
- **错误恢复**：翻译失败的段落保留原文并输出日志。
- **多格式兼容**：为 PDF/XLSX 设计独立适配器，保持格式保真。

## 6. 术语表设计
### 6.1 格式示例（CSV）
```
source,target,case_sensitive,lock
API,API,true,true
CAD,Computer-Aided Design,true,false
```
- `lock=true` 表示不翻译、强制保持原词。

### 6.2 生效策略
- 翻译前：对锁定词进行占位符替换。
- 翻译后：还原占位符并进行强制替换。

## 7. 验收标准
1. 翻译后文件可正常打开且无格式异常。
2. 页眉、页脚、表格、目录结构保持一致。
3. 术语表命中率达到 100%，锁定词不被翻译。
4. 抽检 10% 文档内容，翻译通顺可读。
5. 日志与报告生成完整。

## 8. 风险与应对
- **风险：翻译导致语序变化引发段落不通顺**
  - 应对：支持句级翻译与可配置分段策略。
- **风险：术语表覆盖不全**
  - 应对：提供术语表命中统计与缺失提示。
- **风险：API 限流或失败**
  - 应对：重试与限速，失败段落保留原文。

## 9. 交付物
- 翻译工具可执行脚本/命令行
- 术语表样例
- 运行说明与用户手册
- 翻译报告样例

## 10. 扩展与集成路线
- **Chrome 插件**：实现网页选区翻译、词条提示、翻译结果导出。
- **Microsoft Office 插件**：提供 Word/Excel 内嵌按钮与批量翻译能力。
- **WPS 插件**：对齐 Office 插件能力，保持统一交互与配置。
