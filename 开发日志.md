# 开发日志

## 2026-02-24

### 1. 项目初始化
- 新建独立目录 `doc_translator_tool`，避免影响现有代码。
- 建立命令行入口与模块化结构：CLI、翻译器、适配器、术语表、报告。

### 2. 核心功能实现
- 支持 `.docx`：复制文件并仅替换 XML 文本节点（`w:t`），保留样式与结构。
- 支持 `.xlsx`：翻译字符串单元格，保留工作簿结构与格式。
- 支持文本型 `.pdf`：按文本块覆盖翻译（非 OCR）。
- 支持术语表（CSV/JSON）：锁定词占位保护 + 强制替换。
- 支持批量处理、失败重试、请求限流。

### 3. 多模型 API 适配
- 增加 provider 工厂：`openai` 与 `openai_compatible`。
- 增加本地配置读取：`local.config.json`。
- 新增 OpenAI 路径管理：`OPENAI_BASE_URL`、`OPENAI_ENDPOINT`。
- 兼容第三方 OpenAI 协议接口：`LLM_BASE_URL`、`LLM_ENDPOINT`。

### 4. 稳定性改进
- 修复模型返回非严格 JSON 导致的长度不一致问题：
  - 支持解析 markdown code block 中的 JSON；
  - 支持 `dict` 包装字段回退（`translations/result/data`）；
  - 单段翻译时支持字符串回退。

### 5. 验证记录
- CLI 可用性：`python run.py --help` 正常。
- API 连通性：最小翻译请求返回成功。
- 文件翻译验证：对 `test.docx` 完成英文与中文方向测试，报告显示成功。

### 6. 提交前清理
- 删除测试输出目录与临时探针文件。
- 清理 `__pycache__`。
- `local.config.json` 中密钥已清空，避免泄露。
- 更新 `.gitignore`：忽略输出目录、缓存与字节码文件。

## 2026-02-26

### 1. Web 任务配置回退修复
- 修复 Web 提交任务时的配置回退逻辑：当表单未填写 `api_key/model/base_url/endpoint` 时，自动回退读取本地配置。
- 对 `openai` 与 `openai_compatible` 区分默认 `base_url/endpoint` 来源，保持与 CLI 行为一致。
- 关键改动文件：`webapp.py`。

### 2. 稳定性增强
- 修复“上传文件但无受支持格式时任务失败”的问题：
  - 任务直接标记 `completed`；
  - 生成空结果 `report.json`；
  - 下载接口可正常返回结果包。

### 3. 测试验证
- 无支持格式 smoke：`GET /`、`POST /api/jobs(empty)`、`POST /api/jobs(with file)`、轮询状态、下载接口均符合预期。
- 支持格式端到端 smoke（小 xlsx）：任务完成，进度到 `100%`，输出文件与报告生成成功。
- 大 docx 路径验证：任务可进入翻译流程并输出文件级进度日志。

### 4. 清理与交付
- 删除临时测试脚本与测试输入样例。
- 清理本轮 `web_runs` 测试任务目录，避免污染提交。

## 2026-02-28

### 1. 功能增强（翻译能力）
- 新增源语言自动识别能力：`--source auto`，并在 Web/Office 界面中支持自动识别。
- 新增专业场景参数：`domain`，支持 `general/legal/finance/medical/it/academic`。
- 将 `domain` 贯通到 CLI、Web 提交任务、Web worker 与文本翻译 API。

### 2. 交互与配置完善
- Web 页面新增“专业场景”下拉项。
- Office 插件页面新增“专业场景”下拉项。
- 配置样例新增 `TRANSLATION_DOMAIN` 默认项，便于统一控制默认场景。
- 新增 `test_materials/` 测试素材目录与使用说明文档。

### 3. 稳定性改进
- 增强上游响应解析：兼容对象/字典/字符串返回，避免响应结构差异导致解析失败。
- 对上游返回 HTML 页面场景做显式拦截并给出可诊断错误信息（`provider/base_url/endpoint`）。

### 4. CI/CD 自动化（GitHub Actions）
- 新增工作流：`.github/workflows/ci.yml`。
- 流程包含：
  - 依赖安装（Python 3.10 + `requirements.txt`）；
  - Python 语法编译检查（`py_compile`）；
  - 配置样例与 Office manifest 结构校验；
  - Flask 路由冒烟测试（主页、Office 页面、manifest、API 入参校验）。
- 目标：在无真实 API Key 的 CI 环境下完成可重复、稳定的自动校验。

### 5. 提交前清理
- 更新 `.gitignore`，新增 `output/` 与临时脚本 `scripts/tmp_*.py` 忽略规则。
- 保证开发过程生成的临时产物不进入版本库。
