# 开发日志

## 2026-02-24

### 1. 项目初始化
- 新建独立目录 `doc_translator_tool`，避免影响现有代码。
- 建立命令行入口与模块化结构：CLI、翻译器、适配器、术语表、报告。

### 2. 核心功能实现
- 支持 `.docx`：复制文件并仅替换 XML 文本节点（`w:t`），保留样式与结构。
- 支持 `.xlsx`：翻译字符串单元格，保留工作簿结构与格式。
- 支持文本型 `.pdf`：按文本块覆盖翻译（非 OCR）。
- 支持术语表（CSV/JSON）：锁定词占位保护 + 强制替换。
- 支持批量处理、失败重试、请求限流。

### 3. 多模型 API 适配
- 增加 provider 工厂：`openai` 与 `openai_compatible`。
- 增加本地配置读取：`local.config.json`。
- 新增 OpenAI 路径管理：`OPENAI_BASE_URL`、`OPENAI_ENDPOINT`。
- 兼容第三方 OpenAI 协议接口：`LLM_BASE_URL`、`LLM_ENDPOINT`。

### 4. 稳定性改进
- 修复模型返回非严格 JSON 导致的长度不一致问题：
  - 支持解析 markdown code block 中的 JSON；
  - 支持 `dict` 包装字段回退（`translations/result/data`）；
  - 单段翻译时支持字符串回退。

### 5. 验证记录
- CLI 可用性：`python run.py --help` 正常。
- API 连通性：最小翻译请求返回成功。
- 文件翻译验证：对 `test.docx` 完成英文与中文方向测试，报告显示成功。

### 6. 提交前清理
- 删除测试输出目录与临时探针文件。
- 清理 `__pycache__`。
- `local.config.json` 中密钥已清空，避免泄露。
- 更新 `.gitignore`：忽略输出目录、缓存与字节码文件。

## 2026-02-26

### 1. Web 任务配置回退修复
- 修复 Web 提交任务时的配置回退逻辑：当表单未填写 `api_key/model/base_url/endpoint` 时，自动回退读取本地配置。
- 对 `openai` 与 `openai_compatible` 区分默认 `base_url/endpoint` 来源，保持与 CLI 行为一致。
- 关键改动文件：`webapp.py`。

### 2. 稳定性增强
- 修复“上传文件但无受支持格式时任务失败”的问题：
  - 任务直接标记 `completed`；
  - 生成空结果 `report.json`；
  - 下载接口可正常返回结果包。

### 3. 测试验证
- 无支持格式 smoke：`GET /`、`POST /api/jobs(empty)`、`POST /api/jobs(with file)`、轮询状态、下载接口均符合预期。
- 支持格式端到端 smoke（小 xlsx）：任务完成，进度到 `100%`，输出文件与报告生成成功。
- 大 docx 路径验证：任务可进入翻译流程并输出文件级进度日志。

### 4. 清理与交付
- 删除临时测试脚本与测试输入样例。
- 清理本轮 `web_runs` 测试任务目录，避免污染提交。
